#encoding: utf-8
<% content_for(:page_header_description, "录入合同的基本信息,合同编号唯一，合同正文通过附件上传") %>
<%= content_for :page_specific_stylesheets do %>
  <%= stylesheet_link_tag "jquery-ui-1.10.3.custom.min" %>
  <%= stylesheet_link_tag "chosen" %>
  <%= stylesheet_link_tag 'datepicker' %>
<% end %>

<%= content_for :page_specific_javascripts do %>
  <%= javascript_include_tag 'jquery-ui-1.10.3.custom.min' %>
  <%= javascript_include_tag 'jquery.ui.touch-punch.min' %>
  <%= javascript_include_tag 'chosen.jquery.min' %>
  <%= javascript_include_tag 'fuelux/fuelux.spinner.min' %>
  <%= javascript_include_tag 'date-time/moment.min' %>
  <%= javascript_include_tag 'date-time/bootstrap-datepicker.min' %>
  <%= javascript_include_tag 'date-time/bootstrap-timepicker.min' %>
  <%= javascript_include_tag 'date-time/daterangepicker.min' %>
  <%= javascript_include_tag 'bootstrap-colorpicker.min' %>
<% end %>

<%= form_for @contract, :html=>{:multipart=>true, :class=>"form-horizontal"}  do |f|  %>
  <% if @contract.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@contract.errors.count, "error") %> prohibited this contract from being saved:</h2>

      <ul>
      <% @contract.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row-fluid">
  <div class="span6">
  <div class="control-group">
    <%= f.label :contractno, "<span class='required-field'>*</span>合同编号".html_safe ,:class=>"control-label" %>
    <div class="controls">
    <%= f.text_field :contractno, :class=>"text_field" %>
    </div>
  </div>
  </div>
  </div>


  <div class="row-fluid">
  <div class="span12">
  <div class="control-group">
    <%= f.label :name, "<span class='required-field'>*</span>合同名称".html_safe ,:class=>"control-label" %>
    <div class="controls">
      <%= f.text_field :name , :class=>"input-xxlarge" %>
    </div>
  </div>
  </div>
  </div>

  <div class="row-fluid">
  <div class="span12">
  <div class="control-group">
    <%= f.label :projectname, "<span class='required-field'>*</span>项目名称".html_safe ,:class=>"control-label" %>
    <div class="controls">
      <%= f.text_field :projectname, :class=>"input-xxlarge", :size=>50 %>
    </div>
  </div>
  </div>
  </div>

  
  <div class="row-fluid">
  <div class="span12">
  <div class="control-group">
    <%= f.label "项目所在地" ,:class=>"control-label" %>
    <div class="controls">
      <%= f.text_field :projectaddr, :class=>"input-xxlarge" %>
    </div>
  </div>
  </div>
  </div>


  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "业主名称" ,:class=>"control-label" %>
    <div class="controls" style="position:relative;">
      <span style="margin-left:100px;width:18px;overflow:hidden;">  
        <%= select_tag("ownerselect", options_for_select(Contract.getowner.collect{|d|[d.owner]}), {:style=>"width:218px;margin-left:-100px",:onchange=>"setsibling(this)"}) %>
      </span>  
    <%= f.text_field :owner, :style=>"width:170px;position:absolute;left:0px;" %>
    </div>
  </div>
  </div>

  <div class="span5">
  <div class="control-group">
    <%= f.label "乙方名称" ,:class=>"control-label" %>
    <div class="controls" style="position:relative;">
      <span style="margin-left:100px;width:18px;overflow:hidden;">  
        <%= select_tag("buyerselect", options_for_select(Contract.getbuyer.collect{|d|[d.buyerparty]}), {:style=>"width:218px;margin-left:-100px",:onchange=>"setsibling(this)"}) %>
      </span>
      <%= f.text_field :buyerparty, :style=>"width:170px;position:absolute;left:0px;" %>
    </div>
  </div>
  </div>
  </div>

  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "资金来源" ,:class=>"control-label" %>
    <div class="controls">
      <%= f.select(:fundsource , options_for_select(Dictionary.fundsource.collect{|d|[d.item,d.id]}), :class=>"span4",:prompt=>"请选择") %>
    </div>
  </div>
  </div>

  <div class="span5">
  <div class="control-group">
    <%= f.label "合同金额" ,:class=>"control-label" %>
    <div class="controls">
      <div class="input-append">
        <%= f.text_field :contractamount, :class=>"text_field" %><span class="add-on">元</span>
      </div>
    </div>
  </div>
  </div>
  </div>

  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "开始日期", :class=>"control-label" %>
    <div class="controls">
      <div class="input-append">
        <%= f.text_field :startdate, :class=>"text_field" , :value=>Time.now.strftime("%Y-%m-%d") %><span class="add-on"><i class="icon-calendar"></i></span>

    </div>
    </div>
  </div>
  </div>

  <div class="span5">
  <div class="control-group">
    <%= f.label "截止日期", :class=>"control-label"%>
    <div class="controls">
    <div class="input-append">
      <%= f.text_field :finishdate, :class=>"text_field", :value=>Time.now.change(:year=>Time.now.year+1).strftime("%Y-%m-%d")%><span class="add-on"><i class="icon-calendar"></i></span>
    </div>
    </div>
  </div>
  </div>
  </div>

  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "签订日期", :class=>"control-label" %>
    <div class="controls ">
      <div class="input-append">
      <%= f.text_field :signdate ,:class=>"text_field",:value=>Time.now.strftime("%Y-%m-%d")  %><span class="add-on"><i class="icon-calendar"></i></span>
    </div>
    </div>
  </div>
  </div>


  <div class="span5">
  <div class="control-group">
    <%= f.label "工作量", :class=>"control-label" %>
    <div class="controls ">
      <div class="input-append">
      <%= f.text_field :workshift ,:class=>"text_field",:value=>"500.00"  %><span class="add-on">m</span>
    </div>
    </div>
  </div>
  </div>
  </div>
  

  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "所属部门", :class=>"control-label" %>
    <div class="controls ">
      <div class="input-append">
      <%= f.select(:department_id ,options_for_select(Department.to_select, @contract.department_id), :class=>"span4",:prompt=>"请选择") %>
      </div>
    </div>
  </div>
  </div>


  <div class="span5">
  <div class="control-group">
    <%= f.label "项目经理", :class=>"control-label" %>
    <div class="controls ">
      <div class="input-append">
      <%= f.select(:administrator_id , options_for_select(User.get_all_administrators, @contract.administrator_id), :class=>"span4",:prompt=>"请选择") %>
      </div>
    </div>
  </div>
  </div>

  </div>

  <div class="row-fluid">
  <div class="span5">
  <div class="control-group">
    <%= f.label "合同附件",:class=>"control-label" %>
    <div class="controls">
      <%= f.fields_for :contractassets do |contractasset| %>
        <%= contractasset.file_field :data  %>
      <% end %>
      <% @contract.contractassets.each do |att| %>
        <% if att.id %>
        <span id="att_<%=att.id%>"><%=link_to att.data.url do %><%= att.data_origin_file_name %> <% end %><a href="#" onclick="deleteAttachment(<%=att.id%>)"><i class="icon-remove bigger"></i></a></span>
        <% end %>
      <% end %>
    </div>
  </div>
  </div>
  </div>


  <div class="row-fluid">
  <div class="span12">
  <div class="control-group">
    <%= f.label "备注",:class=>"control-label" %>
    <div class="controls">
      <%= f.text_area :remark,:class=>"input-xxlarge",:rows=>3,:cols=>20 %>
    </div>
  </div>
  </div>
  </div>


  <div class="form-actions">
    <%= f.submit "保存" , :class=>"btn btn-primary" %>
    <%= link_back :class=>'btn btn-info'%>
  </div>
<% end %>
<%= content_for :inline_javascripts do %>
  <%= make_datepicker("#contract_startdate") %>
  <%= make_datepicker("#contract_finishdate") %>
  <%= make_datepicker("#contract_signdate") %>
  <script type="text/javascript">

  $(function(){
//  $('input, textarea').placeholder();
  $("input[type='file']").ace_file_input({
        no_file:'未选择文件 ...',
        btn_choose:'选择',
        btn_change:'重新选择',
        droppable:false,
        onchange:null,
        thumbnail:false //| true | large
        //whitelist:'gif|png|jpg|jpeg'
        //blacklist:'exe|php'
        //onchange:''
        //
        });

  $("#new_contract").validate({
  rules:{
  "contract[name]":{required:true,maxlength:500},
  "contract[contractno]":{required:true, maxlength:50},
  "contract[projectname]":{required:true},
  "contract[owner]":{required:true},
  "contract[fundsource]":{required:true},
  "contract[signdate]":{required:true},
  "contract[startdate]":{required:true},
  "contract[finishdate]":{required:true},
  "contract[contractamount]":{digits:true},
  },
  messages:{
     "contract[name]":{required:"合同名称不能为空",maxlength:"合同名称不能超过500字符"},
     "contract[contractno]":{required:"合同编号不能为空", maxlength:"合同编号不能超过50字符"},
     "contract[projectname]":{required:"工程名称不能为空"},
     "contract[owner]":{required:"合同业主不能为空"},
     "contract[fundsource]":{required:"资金来源不能为空"},
     "contract[signdate]":{required:"签订日期不能为空"},
     "contract[startdate]":{required:"开始日期不能为空"},
     "contract[finishdate]":{required:"截止日期不能为空"},
      "contract[contractamount]":{digits:"必须输入整数"},
  }
 });


  });

   
  function setsibling(obj) 
  {
     $(obj).parent().siblings("input").val($(obj).val());
  }

  function deleteAttachment(id)
  {
    var r = confirm("确认要删除该附件吗？"); 
    if (r==true)
    {
      $.post("<%=contracts_deleteAttachment_path%>", 
        {id: id},
        function(result)
        {
          if(result=="true")
          {
            $("#att_"+id).remove();
            $("input[value='" + id + "']").remove();
          }
        }); 
    }
  }
  </script>
<% end %>
